<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éŸ³ç»˜æ˜Ÿ - è‡ªé—­ç—‡å„¿ç«¥è®¤çŸ¥èƒ½åŠ›ç»“æ„åŒ–æå‡ç³»ç»Ÿ</title>
  <style>
    * { box-sizing: border-box; }

    :root {
      --bg: #f7fbff;
      --panel: #ffffff;
      --panel-2: #f2f7ff;
      --stroke: #e6eefc;
      --text: #1f2a44;
      --muted: #6b7a99;
      --brand: #2f54eb;
      --brand-2: #52c41a;
      --warn: #fa8c16;
      --shadow: 0 10px 30px rgba(47,84,235,0.10);
      --shadow-soft: 0 6px 16px rgba(31,42,68,0.08);
      --radius: 14px;
    }

    body { 
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans"; 
      margin: 0; 
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: radial-gradient(1200px 600px at 20% 10%, #eaf2ff 0%, transparent 60%),
                  radial-gradient(900px 500px at 80% 30%, #fff4e6 0%, transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    /* æ›´é€‚åˆå„¿ç«¥ï¼šæ›´å¤§çš„é»˜è®¤å­—å· */
    body, input, select, textarea, button { font-size: 15px; }
    
    .container {
      display: flex;
      height: 100vh;
      gap: 14px;
      padding: 14px;
    }
    
    /* å·¦ä¾§é¢æ¿ - æ›´åƒå„¿ç«¥åº”ç”¨çš„ä¾§æ å¡ç‰‡ */
    .left-panel {
      width: 320px;
      min-width: 300px;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(8px);
      padding: 16px;
      overflow-y: auto;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }
    
    /* å³ä¾§é¢æ¿ */
    .right-panel {
      flex: 1;
      padding: 14px;
      overflow-y: auto;
      background: rgba(255,255,255,0.70);
      backdrop-filter: blur(8px);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }
    
    h1 { font-size: 22px; margin: 0 0 10px 0; letter-spacing: 0.5px; }
    h2 { font-size: 18px; margin: 18px 0 10px 0; }
    h3 { font-size: 16px; margin: 12px 0 8px 0; }
    
    label { 
      font-weight: 700; 
      display: block; 
      margin-top: 12px; 
      font-size: 14px;
      color: var(--text);
    }
    
    input, select, textarea { 
      width: 100%; 
      padding: 10px 12px; 
      margin: 6px 0 12px; 
      border: 1px solid var(--stroke); 
      border-radius: 12px; 
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 0 rgba(47,84,235,0.05) inset;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(47,84,235,0.55);
      box-shadow: 0 0 0 4px rgba(47,84,235,0.12);
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    button { 
      padding: 12px 16px; 
      cursor: pointer; 
      background: linear-gradient(180deg, #4d72ff 0%, var(--brand) 100%);
      color: white; 
      border: none; 
      border-radius: 14px; 
      font-size: 15px; 
      font-weight: 800;
      width: 100%;
      margin: 6px 0;
      box-shadow: var(--shadow);
      transition: transform 0.08s ease, filter 0.15s ease;
    }
    
    button:hover { filter: brightness(1.02); }
    button:active { transform: translateY(1px) scale(0.99); }
    button:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

    /* æ›´é€‚åˆå„¿ç«¥ï¼šæŒ‰é’®å¸¦å›¾æ ‡æ—¶æ›´å±…ä¸­ */
    button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    
    .nav-buttons {
      display: flex;
      gap: 8px;
      margin: 16px 0;
    }
    
    .nav-buttons button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border-radius: 12px;
    }
    
    .btn-prev { background: linear-gradient(180deg, #69d13b 0%, var(--brand-2) 100%); }
    .btn-next { background: linear-gradient(180deg, #4d72ff 0%, var(--brand) 100%); }
    .btn-regenerate { background: linear-gradient(180deg, #ff9a3f 0%, var(--warn) 100%); }
    
    .muted { color: var(--muted); font-size: 12px; }
    .ok { color: #0a7b2a; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }
    
    .section { 
      margin: 14px 0; 
      padding: 14px; 
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
    }
    
    .character-info { 
      padding: 14px; 
      background: linear-gradient(180deg, #e9f6ff 0%, #f6fbff 100%);
      border-radius: var(--radius);
      margin: 12px 0; 
      font-size: 14px;
      border: 1px solid rgba(47,84,235,0.15);
      box-shadow: 0 6px 18px rgba(24,144,255,0.08);
    }
    
    .loading { 
      display: inline-block; 
      width: 16px; 
      height: 16px; 
      border: 2px solid #f3f3f3; 
      border-top: 2px solid #2f54eb; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* å³ä¾§å†…å®¹åŒºåŸŸ */
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
    }
    
    .step-header {
      margin-bottom: 14px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.8);
      box-shadow: var(--shadow-soft);
    }
    
    .step-header h2 {
      color: var(--brand);
      margin: 0 0 8px 0;
      font-size: 20px;
    }
    
    .step-info {
      color: #666;
      font-size: 14px;
      margin: 8px 0;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      margin: 14px 0;
      align-items: stretch;
    }
    
    .content-box {
      background: rgba(255,255,255,0.85);
      border-radius: var(--radius);
      padding: 14px;
      border: 1px solid var(--stroke);
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-soft);
      position: relative;
    }
    
    .content-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--brand);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* å›ºå®šæ­Œè¯åŒºåŸŸé«˜åº¦ï¼ˆå¯æ»šåŠ¨ï¼‰ï¼Œæ›´é€‚åˆå„¿ç«¥é˜…è¯» */
    .lyrics-box {
      background: linear-gradient(180deg, #f6fbff 0%, #ffffff 100%);
      padding: 18px;
      border-radius: 14px;
      border: 1px dashed rgba(47,84,235,0.25);
      white-space: pre-wrap;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans";
      font-size: 18px;
      line-height: 1.9;
      overflow-y: auto;
      height: 928px; /* ä¸å›¾ç‰‡ä¸€è‡´ï¼šå…¨é«˜åº¦å±•ç¤ºæ­Œè¯ */
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }
    
    /* å›ºå®šå›¾ç‰‡åŒºåŸŸé«˜åº¦ä¸æ¯”ä¾‹ï¼ˆ16:9ï¼‰ï¼Œé¿å…è·³åŠ¨ */
    .image-box {
      width: 100%;
      height: 928px; /* åŸå›¾é«˜åº¦ï¼šå…¨å°ºå¯¸å±•ç¤º */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto; /* å…è®¸æ»šåŠ¨ï¼Œå±•ç¤ºåŸå›¾å…¨å°ºå¯¸ */
      background: linear-gradient(180deg, #fff8ee 0%, #ffffff 100%);
      border-radius: 14px;
      border: 1px solid rgba(250,140,22,0.18);
      position: relative;
    }
    
    /* åŸå›¾ä¸º 1664x928ï¼šè¿™é‡ŒæŒ‰åŸå§‹åƒç´ æ¸²æŸ“ï¼Œå®¹å™¨ä¸è¶³åˆ™æ»šåŠ¨æŸ¥çœ‹ */
    .image-box img {
      width: 1664px;
      height: 928px;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(31,42,68,0.12);
      max-width: none;
      max-height: none;
    }
    
    .audio-box {
      min-height: 50px;
      margin-top: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 8px 0;
    }
    
    .audio-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .audio-control-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: #2f54eb;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .audio-control-btn:hover {
      background: #1d39c4;
    }
    
    .audio-control-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .audio-control-btn.pause {
      background: #fa8c16;
    }
    
    .audio-control-btn.pause:hover {
      background: #d46b08;
    }
    
    .audio-control-btn.restart {
      background: #52c41a;
    }
    
    .audio-control-btn.restart:hover {
      background: #389e0d;
    }
    
    .audio-progress-container {
      flex: 1;
      margin: 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .audio-progress-bar {
      flex: 1;
      height: 20px;
      background: #e8e8e8;
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      overflow: visible;
      display: flex;
      align-items: center;
    }
    
    .audio-progress-fill {
      height: 6px;
      background: #2f54eb;
      border-radius: 3px;
      transition: width 0.1s linear;
      position: relative;
    }
    
    .audio-progress-thumb {
      width: 14px;
      height: 14px;
      background: #2f54eb;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: transform 0.1s;
    }
    
    .audio-progress-thumb:hover {
      transform: translate(-50%, -50%) scale(1.2);
    }
    
    .audio-progress-thumb:active {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.3);
    }
    
    .audio-time {
      font-size: 12px;
      color: #666;
      min-width: 80px;
      text-align: center;
      font-family: monospace;
    }
    
    .audio-hidden {
      display: none;
    }
    
    /* ä¸‹è½½æŒ‰é’®æ ·å¼ */
    .download-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(180deg, #4d72ff 0%, var(--brand) 100%);
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(47,84,235,0.3);
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .download-btn:hover {
      background: linear-gradient(180deg, #6b8aff 0%, #4d72ff 100%);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(47,84,235,0.4);
    }
    
    .download-btn:active {
      transform: scale(0.95);
    }
    
    .download-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* æ€»ä¸‹è½½æŒ‰é’® - åœ¨æ­Œè¯ä¸‹æ–¹ */
    .download-all-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(180deg, #4d72ff 0%, var(--brand) 100%);
      color: white;
      font-size: 22px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(47,84,235,0.3);
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .download-all-btn:hover {
      background: linear-gradient(180deg, #6b8aff 0%, #4d72ff 100%);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(47,84,235,0.4);
    }
    
    .download-all-btn:active {
      transform: scale(0.95);
    }
    
    .download-all-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .download-all-btn.show {
      display: flex;
    }
    
    /* å†å²è®°å½•æŒ‰é’®æ ·å¼ */
    .history-btn {
      width: 100%;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(180deg, #4d72ff 0%, var(--brand) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(47,84,235,0.3);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .history-btn:hover {
      background: linear-gradient(180deg, #6b8aff 0%, #4d72ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(47,84,235,0.4);
    }
    
    .history-btn:active {
      transform: translateY(0);
    }
    
    /* å†å²è®°å½•æ¨¡æ€æ¡†æ ·å¼ */
    .history-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .history-modal.active {
      display: flex;
    }
    
    .history-modal-content {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .history-close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      line-height: 1;
    }
    
    .history-close-btn:hover {
      background: var(--panel-2);
      color: var(--text);
    }
    
    .history-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 300px;
    }
    
    .history-item {
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      background: var(--panel);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      transition: all 0.2s;
    }
    
    .history-item:hover {
      border-color: var(--brand);
      box-shadow: 0 4px 12px rgba(47,84,235,0.1);
      transform: translateY(-2px);
    }
    
    .history-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .history-item-meta-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    
    .history-item-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    
    .history-item-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .history-item-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--brand);
      color: white;
      white-space: nowrap;
      width: 56px;
      min-width: 56px;
      max-width: 56px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .history-item-btn:hover {
      background: #1d39c4;
      transform: translateY(-1px);
    }
    
    .history-item-btn:active {
      transform: translateY(0);
    }
    
    .history-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .history-loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .history-pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 12px 0;
      border-top: 1px solid var(--stroke);
    }
    
    .history-page-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--stroke);
      border-radius: 8px;
      background: white;
      color: var(--text);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .history-page-btn:hover:not(:disabled) {
      border-color: var(--brand);
      background: var(--panel-2);
      color: var(--brand);
    }
    
    .history-page-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .history-page-info {
      font-size: 14px;
      color: var(--muted);
      min-width: 60px;
      text-align: center;
    }
    
    /* ç§¯æœ¨æ‹¼æ¥åŠ¨ç”» */
    .building-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .building-animation.hidden {
      display: none;
    }
    
    .building-title {
      font-size: 24px;
      color: #2f54eb;
      margin-bottom: 40px;
      font-weight: bold;
    }
    
    .blocks-container {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    .building-block {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: buildUp 0.6s ease-out forwards, floatAnimation 2s ease-in-out infinite;
      opacity: 0;
      transform: translateY(50px);
    }
    
    .building-block:nth-child(1) {
      background: #ff6b6b;
      animation-delay: 0.1s, 0.7s;
      height: 60px;
    }
    
    .building-block:nth-child(2) {
      background: #4ecdc4;
      animation-delay: 0.2s, 0.8s;
      height: 80px;
    }
    
    .building-block:nth-child(3) {
      background: #ffe66d;
      animation-delay: 0.3s, 0.9s;
      height: 100px;
    }
    
    .building-block:nth-child(4) {
      background: #95e1d3;
      animation-delay: 0.4s, 1.0s;
      height: 80px;
    }
    
    .building-block:nth-child(5) {
      background: #f38181;
      animation-delay: 0.5s, 1.1s;
      height: 60px;
    }
    
    @keyframes buildUp {
      0% {
        opacity: 0;
        transform: translateY(50px) scale(0.8);
      }
      50% {
        transform: translateY(-10px) scale(1.1);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes floatAnimation {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      25% {
        transform: translateY(-15px) rotate(2deg);
      }
      50% {
        transform: translateY(-5px) rotate(0deg);
      }
      75% {
        transform: translateY(-20px) rotate(-2deg);
      }
    }
    
    /* ç§¯æœ¨æ‹¼æ¥æ•ˆæœ - æŒç»­å¾ªç¯ */
    @keyframes connectAnimation {
      0%, 100% {
        transform: translateX(0) scale(1);
      }
      50% {
        transform: translateX(5px) scale(1.05);
      }
    }
    
    .blocks-container {
      animation: connectAnimation 3s ease-in-out infinite;
    }
    
    .building-status {
      margin-top: 30px;
      font-size: 16px;
      color: #666;
    }
    
    /* å°å‹ç§¯æœ¨åŠ¨ç”»ï¼ˆç”¨äºæ­Œè¯å’Œå›¾ç‰‡åŒºåŸŸï¼‰ */
    .mini-building-animation {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      padding: 20px;
    }
    
    .mini-blocks-container {
      display: flex;
      gap: 6px;
      align-items: flex-end;
    }
    
    .mini-building-block {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      animation: miniBuildUp 0.6s ease-out forwards, miniFloatAnimation 2s ease-in-out infinite;
      opacity: 0;
      transform: translateY(30px);
    }
    
    .mini-building-block:nth-child(1) {
      background: #ff6b6b;
      animation-delay: 0.1s, 0.7s;
      height: 30px;
    }
    
    .mini-building-block:nth-child(2) {
      background: #4ecdc4;
      animation-delay: 0.2s, 0.8s;
      height: 40px;
    }
    
    .mini-building-block:nth-child(3) {
      background: #ffe66d;
      animation-delay: 0.3s, 0.9s;
      height: 50px;
    }
    
    .mini-building-block:nth-child(4) {
      background: #95e1d3;
      animation-delay: 0.4s, 1.0s;
      height: 40px;
    }
    
    .mini-building-block:nth-child(5) {
      background: #f38181;
      animation-delay: 0.5s, 1.1s;
      height: 30px;
    }
    
    @keyframes miniBuildUp {
      0% {
        opacity: 0;
        transform: translateY(30px) scale(0.8);
      }
      50% {
        transform: translateY(-5px) scale(1.1);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes miniFloatAnimation {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      25% {
        transform: translateY(-8px) rotate(2deg);
      }
      50% {
        transform: translateY(-3px) rotate(0deg);
      }
      75% {
        transform: translateY(-10px) rotate(-2deg);
      }
    }
    
    .mini-blocks-container {
      animation: miniConnectAnimation 3s ease-in-out infinite;
    }
    
    @keyframes miniConnectAnimation {
      0%, 100% {
        transform: translateX(0) scale(1);
      }
      50% {
        transform: translateX(3px) scale(1.05);
      }
    }
    
    .status-message {
      padding: 12px;
      border-radius: 4px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .status-message.info {
      background: #e6f7ff;
      color: #1890ff;
    }
    
    .status-message.success {
      background: #f6ffed;
      color: #52c41a;
    }
    
    .status-message.error {
      background: #fff2e8;
      color: #fa8c16;
    }
    
    .progress-indicator {
      margin: 16px 0;
      padding: 12px;
      background: #f0f0f0;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .step-indicator {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    
    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      border: 2px solid #ddd;
      background: white;
      color: #666;
    }
    
    .step-dot.active {
      background: #2f54eb;
      color: white;
      border-color: #2f54eb;
    }
    
    .step-dot.completed {
      background: #52c41a;
      color: white;
      border-color: #52c41a;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§é¢æ¿ - 20% -->
    <div class="left-panel">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding: 10px 12px; border-radius: 16px; background: rgba(255,255,255,0.8); border: 1px solid var(--stroke); box-shadow: var(--shadow-soft);">
        <img src="yinhuixing.png" alt="éŸ³ç»˜æ˜Ÿ" style="width: 44px; height: 44px; object-fit: contain;" />
        <div>
          <h1 style="margin: 0; font-size: 22px; color: var(--brand);">éŸ³ç»˜æ˜Ÿ</h1>
          <div class="muted" style="font-size: 12px; margin-top: 2px;">3-6å²å„¿ç«¥è®¤çŸ¥å­¦ä¹ </div>
      </div>
      </div>

      <div class="section">
        <h2 style="font-size: 16px; margin-top: 0;">ğŸ“ è®¾ç½®å­¦ä¹ ç›®æ ‡</h2>
        <div class="muted" style="margin-top: 6px;">é€‚åˆ3-6å²å„¿ç«¥ Â· è‰²å½©æ¸©æŸ” Â· æ“ä½œç®€å•</div>
        
        <label>å­¦ä¹ ç›®æ ‡</label>
        <input id="userGoal" placeholder="ä¾‹å¦‚ï¼šè®¤è¯†é’Ÿè¡¨" value="è®¤è¯†é’Ÿè¡¨" />

        <label>ç›®æ ‡é‡ç‚¹</label>
        <textarea id="learningFocus" placeholder="ä¾‹å¦‚ï¼šè®©å­©å­å­¦ä¼šè®¤è¯†æ—¶é’ˆå’Œåˆ†é’ˆï¼Œç†è§£æ—¶é—´çš„æ¦‚å¿µ" rows="3"></textarea>

        <label>éŸ³ä¹é£æ ¼</label>
        <select id="musicStyle">
          <option value="æ¬¢å¿«" selected>æ¬¢å¿«</option>
          <option value="æ¸©æš–">æ¸©æš–</option>
          <option value="èˆ’ç¼“">èˆ’ç¼“</option>
          <option value="ç«¥è¯">ç«¥è¯</option>
          <option value="custom">è‡ªå®šä¹‰è¾“å…¥</option>
        </select>
        <input id="musicStyleCustom" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰éŸ³ä¹é£æ ¼" style="display: none; margin-top: 6px;" />

        <label>éŸ³ä¹å£°éŸ³</label>
        <select id="musicVoice">
          <option value="ç”·ç”Ÿ" selected>ç”·ç”Ÿ</option>
          <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
          <option value="çˆ¸çˆ¸">çˆ¸çˆ¸</option>
          <option value="å¦ˆå¦ˆ">å¦ˆå¦ˆ</option>
          <option value="custom">è‡ªå®šä¹‰è¾“å…¥</option>
        </select>
        <input id="musicVoiceCustom" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰å£°éŸ³ç±»å‹" style="display: none; margin-top: 6px;" />

        <label>ç»˜æœ¬é£æ ¼</label>
        <select id="pictureBookStyle">
          <option value="ç«¥è¯" selected>ç«¥è¯</option>
          <option value="å¯çˆ±">å¯çˆ±</option>
          <option value="ç§‘å¹»">ç§‘å¹»</option>
          <option value="ç«¥å¹´">ç«¥å¹´</option>
          <option value="custom">è‡ªå®šä¹‰è¾“å…¥</option>
        </select>
        <input id="pictureBookStyleCustom" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç»˜æœ¬é£æ ¼" style="display: none; margin-top: 6px;" />

        <label>è§’è‰²é€‰æ‹©</label>
        <select id="characterType">
          <option value="ç”·ç”Ÿ" selected>ç”·ç”Ÿ</option>
          <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
          <option value="çˆ¸çˆ¸">çˆ¸çˆ¸</option>
          <option value="å¦ˆå¦ˆ">å¦ˆå¦ˆ</option>
          <option value="åŠ¨ç‰©">åŠ¨ç‰©</option>
          <option value="custom">è‡ªå®šä¹‰è¾“å…¥</option>
        </select>
        <input id="characterTypeCustom" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰è§’è‰²ç±»å‹" style="display: none; margin-top: 6px;" />

        <button id="btnDecompose">ğŸ” åˆ†è§£å­¦ä¹ ç›®æ ‡</button>
        <div id="decomposeStatus" class="muted" style="margin-top: 8px; font-size: 12px;"></div>
      </div>

      <div id="characterInfo" class="character-info" style="display: none;">
        <strong>ğŸ­ è§’è‰²ä¿¡æ¯</strong>
        <div id="characterDetails" style="margin-top: 8px;"></div>
      </div>

      <div class="section" style="margin-top: 16px;">
        <button id="btnHistory" class="history-btn" onclick="showHistoryModal()">
          ğŸ“š å†å²ç”Ÿæˆ
        </button>
      </div>

      <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
      <div id="historyModal" class="history-modal">
        <div class="history-modal-content">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 18px; color: var(--brand);">ğŸ“š å†å²ç”Ÿæˆè®°å½•</h2>
            <button class="history-close-btn" onclick="hideHistoryModal()" title="å…³é—­">Ã—</button>
          </div>
          <div class="history-container">
            <div id="historyList" class="history-list">
              <div class="history-loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>
            </div>
            <div class="history-pagination" id="historyPagination" style="display: none;">
              <button class="history-page-btn" id="historyPrevBtn" onclick="historyPrevPage()">â—€</button>
              <span class="history-page-info" id="historyPageInfo">1 / 1</span>
              <button class="history-page-btn" id="historyNextBtn" onclick="historyNextPage()">â–¶</button>
            </div>
          </div>
        </div>
      </div>

      <div id="stepsSection" style="display: none;">
        <div class="section">
          <h2 style="font-size: 16px; margin-top: 0;">ğŸ“š å­¦ä¹ æ­¥éª¤</h2>
          <div id="stepIndicator" class="step-indicator"></div>
          
          <div class="nav-buttons">
            <button id="btnPrev" class="btn-prev" disabled>â—€ ä¸Šä¸€æ­¥</button>
            <button id="btnNext" class="btn-next" disabled>ä¸‹ä¸€æ­¥ â–¶</button>
          </div>
          
          <button id="btnRegenerate" class="btn-regenerate" disabled>ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
          <button id="btnGenerateAll" style="display: none; background: #722ed1; margin-top: 8px;">âš¡ ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰å†…å®¹</button>
          
          <div id="generateStatus" class="muted" style="margin-top: 8px; font-size: 12px;"></div>
        </div>
      </div>
    </div>

    <!-- å³ä¾§é¢æ¿ - 80% -->
    <div class="right-panel">
      <div id="welcomeMessage" style="text-align: center; padding: 100px 20px; color: #999;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;">
          <img src="yinhuixing.png" alt="éŸ³ç»˜æ˜Ÿ" style="width: 80px; height: 80px; object-fit: contain;" />
          <h2 style="margin: 0; font-size: 32px; color: #2f54eb;">éŸ³ç»˜æ˜Ÿ</h2>
        </div>
        <p style="font-size: 16px; margin-top: 10px;">æ¬¢è¿ä½¿ç”¨è®¤çŸ¥èƒ½åŠ›ç»“æ„åŒ–æå‡ç³»ç»Ÿ</p>
        <p style="font-size: 14px; margin-top: 8px;">è¯·åœ¨å·¦ä¾§è®¾ç½®å­¦ä¹ ç›®æ ‡å¹¶å¼€å§‹åˆ†è§£</p>
      </div>

      <div id="stepsContainer" style="display: none;">
        <!-- æ­¥éª¤å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- ç§¯æœ¨æ‹¼æ¥åŠ¨ç”» -->
  <div id="buildingAnimation" class="building-animation hidden">
    <div class="building-title">ğŸµ æ­£åœ¨æ„å»ºå­¦ä¹ æ–¹æ¡ˆ...</div>
    <div class="blocks-container">
      <div class="building-block"></div>
      <div class="building-block"></div>
      <div class="building-block"></div>
      <div class="building-block"></div>
      <div class="building-block"></div>
    </div>
    <div class="building-status" id="buildingStatus">å‡†å¤‡å¼€å§‹...</div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  
  // å…¨å±€å˜é‡
  let decomposedData = null;
  let currentStepIndex = 0;
  let stepContents = []; // å­˜å‚¨æ‰€æœ‰æ­¥éª¤çš„å†…å®¹ç¼“å­˜
  let isGeneratingAll = false;
  let currentSessionId = null; // å½“å‰ä¼šè¯IDï¼Œç”¨äºä¿å­˜æ–‡ä»¶
  let historyData = []; // å†å²è®°å½•æ•°æ®
  let historyCurrentPage = 1; // å½“å‰å†å²è®°å½•é¡µç 
  const historyPageSize = 5; // æ¯é¡µæ˜¾ç¤ºçš„å†å²è®°å½•æ•°é‡

  // å¤„ç†è‡ªå®šä¹‰è¾“å…¥æ˜¾ç¤º/éšè—
  function setupCustomInputs() {
    // éŸ³ä¹é£æ ¼è‡ªå®šä¹‰
    $('musicStyle').addEventListener('change', function() {
      $('musicStyleCustom').style.display = this.value === 'custom' ? 'block' : 'none';
      if (this.value !== 'custom') {
        $('musicStyleCustom').value = '';
      }
    });

    // éŸ³ä¹å£°éŸ³è‡ªå®šä¹‰
    $('musicVoice').addEventListener('change', function() {
      $('musicVoiceCustom').style.display = this.value === 'custom' ? 'block' : 'none';
      if (this.value !== 'custom') {
        $('musicVoiceCustom').value = '';
      }
    });

    // ç»˜æœ¬é£æ ¼è‡ªå®šä¹‰
    $('pictureBookStyle').addEventListener('change', function() {
      $('pictureBookStyleCustom').style.display = this.value === 'custom' ? 'block' : 'none';
      if (this.value !== 'custom') {
        $('pictureBookStyleCustom').value = '';
      }
    });

    // è§’è‰²é€‰æ‹©è‡ªå®šä¹‰
    $('characterType').addEventListener('change', function() {
      $('characterTypeCustom').style.display = this.value === 'custom' ? 'block' : 'none';
      if (this.value !== 'custom') {
        $('characterTypeCustom').value = '';
      }
    });
  }

  // è·å–å®é™…çš„å€¼ï¼ˆå¤„ç†è‡ªå®šä¹‰è¾“å…¥ï¼‰
  function getActualValue(selectId, customInputId) {
    const select = $(selectId);
    const customInput = $(customInputId);
    if (select.value === 'custom' && customInput.value.trim()) {
      return customInput.value.trim();
    }
    return select.value;
  }

  // åˆ†è§£ç”¨æˆ·ç›®æ ‡
  async function decomposeGoal() {
    const userGoal = $('userGoal').value.trim();
    const learningFocus = $('learningFocus').value.trim();
    const musicStyle = getActualValue('musicStyle', 'musicStyleCustom');
    const musicVoice = getActualValue('musicVoice', 'musicVoiceCustom');
    const pictureBookStyle = getActualValue('pictureBookStyle', 'pictureBookStyleCustom');
    const characterType = getActualValue('characterType', 'characterTypeCustom');
    const decomposeStatusEl = $('decomposeStatus');

    if (!userGoal) {
      decomposeStatusEl.className = 'err';
      decomposeStatusEl.textContent = 'è¯·è¾“å…¥å­¦ä¹ ç›®æ ‡';
      return;
    }

    decomposeStatusEl.className = 'muted';
    decomposeStatusEl.innerHTML = '<span class="loading"></span> æ­£åœ¨åˆ†è§£...';
    $('btnDecompose').disabled = true;

    // æ˜¾ç¤ºç§¯æœ¨æ‹¼æ¥åŠ¨ç”»
    const buildingAnim = $('buildingAnimation');
    const buildingStatus = $('buildingStatus');
    buildingAnim.classList.remove('hidden');
    buildingStatus.textContent = 'æ­£åœ¨åˆ†æå­¦ä¹ ç›®æ ‡...';

    try {
      // æ¨¡æ‹Ÿç§¯æœ¨æ‹¼æ¥è¿‡ç¨‹
      setTimeout(() => {
        buildingStatus.textContent = 'æ­£åœ¨åˆ†è§£å­¦ä¹ æ­¥éª¤...';
      }, 1000);

      console.log('Sending decompose request:', { userGoal, learningFocus, musicStyle, musicVoice, pictureBookStyle, characterType });
      
      const resp = await fetch('/api/decompose-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          userGoal, 
          learningFocus, 
          musicStyle, 
          musicVoice, 
          pictureBookStyle, 
          characterType 
        }),
      }).catch(err => {
        console.error('Fetch error:', err);
        throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${err.message || 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ'}`);
      });

      console.log('Response status:', resp.status, resp.statusText);

      const data = await resp.json().catch(() => {
        console.error('Failed to parse JSON response');
        return { error: 'æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼' };
      });

      if (!resp.ok) {
        console.error('Response error:', data);
        throw new Error(data?.error || `HTTP ${resp.status}: ${resp.statusText}`);
      }

      decomposedData = data.result;
      currentStepIndex = 0;
      stepContents = [];
      currentSessionId = null; // é‡ç½®ä¼šè¯IDï¼Œæ–°çš„åˆ†è§£ä¼šåˆ›å»ºæ–°çš„ä¼šè¯

      // æ›´æ–°åŠ¨ç”»çŠ¶æ€
      buildingStatus.textContent = 'æ­£åœ¨æ„å»ºå­¦ä¹ æ–¹æ¡ˆ...';

      // æ˜¾ç¤ºè§’è‰²ä¿¡æ¯
      if (decomposedData.character_name) {
        $('characterInfo').style.display = 'block';

        const cs = decomposedData.character_sheet;
        const csText = cs && cs.reference_prompt ? cs.reference_prompt : '';

        $('characterDetails').innerHTML = `
          <div><strong>è§’è‰²ï¼š</strong>${decomposedData.character_name}</div>
          <div style="margin-top: 4px;"><strong>æè¿°ï¼š</strong>${decomposedData.character_description || 'å¯çˆ±çš„å­¦ä¹ ä¼™ä¼´'}</div>
          ${csText ? `<div style="margin-top: 8px;"><strong>è®¾å®šå¡ï¼š</strong>${csText}</div>` : ''}
        `;
      }

      // æ˜¾ç¤ºæ­¥éª¤åŒºåŸŸ
      if (decomposedData.steps && decomposedData.steps.length > 0) {
        buildingStatus.textContent = 'å®Œæˆï¼è¿›å…¥å­¦ä¹ æ­¥éª¤...';
        
        // å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
        setTimeout(() => {
          // éšè—åŠ¨ç”»
          buildingAnim.classList.add('hidden');
          
          $('stepsSection').style.display = 'block';
          $('welcomeMessage').style.display = 'none';
          $('stepsContainer').style.display = 'block';
          
          renderStepIndicator();
          renderStepContents();
          showCurrentStep();
          updateNavigationButtons();
          
          // è‡ªåŠ¨å¼€å§‹ç”Ÿæˆæ‰€æœ‰å†…å®¹
          setTimeout(() => {
            generateAllSteps();
          }, 1000);
        }, 800);
      } else {
        buildingAnim.classList.add('hidden');
      }

      decomposeStatusEl.className = 'ok';
      decomposeStatusEl.textContent = 'âœ… åˆ†è§£å®Œæˆï¼';
    } catch (e) {
      console.error('Decompose error:', e);
      buildingAnim.classList.add('hidden');
      decomposeStatusEl.className = 'err';
      const errorMsg = e?.message || String(e) || 'æœªçŸ¥é”™è¯¯';
      decomposeStatusEl.textContent = 'åˆ†è§£å¤±è´¥ï¼š' + errorMsg;
      
      // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
      if (errorMsg.includes('Failed to fetch') || errorMsg.includes('ç½‘ç»œè¯·æ±‚å¤±è´¥')) {
        decomposeStatusEl.textContent = 'åˆ†è§£å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼ˆnode server.jsï¼‰';
      }
    } finally {
      $('btnDecompose').disabled = false;
    }
  }

  // æ¸²æŸ“æ­¥éª¤æŒ‡ç¤ºå™¨
  function renderStepIndicator() {
    const indicatorEl = $('stepIndicator');
    indicatorEl.innerHTML = '';
    
    decomposedData.steps.forEach((step, index) => {
      const dot = document.createElement('div');
      dot.className = 'step-dot';
      dot.textContent = index + 1;
      dot.id = `stepDot${index}`;
      indicatorEl.appendChild(dot);
    });
  }

  // æ¸²æŸ“æ‰€æœ‰æ­¥éª¤å†…å®¹åŒºåŸŸ
  function renderStepContents() {
    const containerEl = $('stepsContainer');
    containerEl.innerHTML = '';

    decomposedData.steps.forEach((step, index) => {
      const stepEl = document.createElement('div');
      stepEl.className = 'step-content';
      stepEl.id = `stepContent${index}`;
      
      stepEl.innerHTML = `
        <div class="step-header">
          <h2 style="margin: 0;">æ­¥éª¤ ${step.step_number || (index + 1)}ï¼š${step.step_name}</h2>
          <div class="step-info">
            <div><strong>æè¿°ï¼š</strong>${step.step_description}</div>
            <div style="margin-top: 8px;"><strong>å­¦ä¹ ç›®æ ‡ï¼š</strong>${step.learning_objective}</div>
          </div>
        </div>
        
        <div id="stepResult${index}" class="content-grid">
          <div class="content-box">
            <h3>ğŸ“ æ­Œè¯</h3>
            <div id="stepLyrics${index}" class="lyrics-box">ç­‰å¾…ç”Ÿæˆ...</div>
            <button class="download-btn" id="downloadLyricsBtn${index}" onclick="downloadLyrics(${index})" title="ä¸‹è½½æ­Œè¯" style="display: none;">ğŸ–‹ï¸</button>
            <button class="download-all-btn" id="downloadAllBtn${index}" onclick="downloadAllStepContent(${index})" title="ä¸‹è½½å…¨éƒ¨" style="display: none;">ğŸ–‹ï¸</button>
          </div>
          
          <div class="content-box">
            <h3>ğŸ–¼ï¸ å›¾ç‰‡</h3>
            <div id="stepImage${index}" class="image-box" style="text-align: center; color: #999;">
              ç­‰å¾…ç”Ÿæˆ...
            </div>
            <button class="download-btn" id="downloadImageBtn${index}" onclick="downloadImage(${index})" title="ä¸‹è½½å›¾ç‰‡" style="display: none;">ğŸ–‹ï¸</button>
          </div>
        </div>
        
        <div class="content-box" style="margin-top: 20px; min-height: 80px; padding: 16px; position: relative;">
          <h3 style="margin: 0 0 12px 0; font-size: 16px;">ğŸµ éŸ³ä¹</h3>
          <div id="stepAudio${index}" class="audio-box" style="text-align: center; color: #999;">
            ç­‰å¾…ç”Ÿæˆ...
          </div>
          <button class="download-btn" id="downloadAudioBtn${index}" onclick="downloadAudio(${index})" title="ä¸‹è½½éŸ³é¢‘" style="display: none;">ğŸ–‹ï¸</button>
        </div>
        
      `;
      
      containerEl.appendChild(stepEl);
    });
  }

  // å›¾ç‰‡é¢„åŠ è½½ç¼“å­˜ï¼ˆå‡å°‘åˆ‡æ¢æ­¥éª¤æ—¶çš„ç­‰å¾…ï¼‰
  const imagePreloadCache = new Map(); // url -> Promise

  function preloadImage(url) {
    if (!url) return Promise.resolve(false);
    if (imagePreloadCache.has(url)) return imagePreloadCache.get(url);

    const p = new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(true);
      img.onerror = () => resolve(false);
      // é¿å…æŸäº› CDN å› ç¼“å­˜ç­–ç•¥å¯¼è‡´é‡å¤ä¸‹è½½ï¼Œæ˜¾å¼è®¾ç½® crossOrigin ä¸å½±å“åŠ è½½
      img.src = url;
    });

    imagePreloadCache.set(url, p);
    return p;
  }

  // æ˜¾ç¤ºå½“å‰æ­¥éª¤
  function showCurrentStep() {
    // é¢„åŠ è½½ï¼šå½“å‰ + ä¸‹ä¸€æ­¥ï¼ˆå¦‚æœæœ‰ï¼‰
    const content = stepContents[currentStepIndex];
    if (content?.imageUrl) preloadImage(content.imageUrl);

    const nextContent = stepContents[currentStepIndex + 1];
    if (nextContent?.imageUrl) preloadImage(nextContent.imageUrl);

    // éšè—æ‰€æœ‰æ­¥éª¤
    decomposedData.steps.forEach((step, index) => {
      const stepEl = $(`stepContent${index}`);
      if (stepEl) {
        stepEl.classList.remove('active');
      }
      
      // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
      const dotEl = $(`stepDot${index}`);
      if (dotEl) {
        dotEl.classList.remove('active', 'completed');
        if (index < currentStepIndex) {
          dotEl.classList.add('completed');
        } else if (index === currentStepIndex) {
          dotEl.classList.add('active');
        }
      }
    });
    
    // æ˜¾ç¤ºå½“å‰æ­¥éª¤
    const currentStepEl = $(`stepContent${currentStepIndex}`);
    if (currentStepEl) {
      currentStepEl.classList.add('active');
      
      // å¦‚æœå·²ç”Ÿæˆå†…å®¹ï¼Œæ˜¾ç¤ºç¼“å­˜çš„å†…å®¹
      if (stepContents[currentStepIndex]) {
        displayStepContent(currentStepIndex);
      } else {
        // å¦‚æœå½“å‰æ­¥éª¤æ²¡æœ‰å†…å®¹ï¼Œéšè—ä¸‹è½½å…¨éƒ¨æŒ‰é’®
        const downloadAllBtn = $(`downloadAllBtn${currentStepIndex}`);
        if (downloadAllBtn) {
          downloadAllBtn.style.display = 'none';
        }
      }
    }
  }

  // æ¸…ç†æ­Œè¯å†…å®¹ï¼Œç§»é™¤Sunoæ ¼å¼æ ‡è®°
  function cleanLyrics(lyrics) {
    if (!lyrics) return '';
    
    // ç§»é™¤ [Suno Style: ...] æ ¼å¼çš„æ ‡è®°
    lyrics = lyrics.replace(/\[Suno Style:.*?\]/gi, '');
    
    // ç§»é™¤ [Intro]ã€[Outro]ã€[Bridge] ç­‰æ ‡è®°åŠå…¶å†…å®¹
    lyrics = lyrics.replace(/\[Intro\].*?(\[Verse\]|\[Chorus\])/gis, '$1');
    lyrics = lyrics.replace(/\[Outro\].*?$/gis, '');
    lyrics = lyrics.replace(/\[Bridge\].*?(\[Verse\]|\[Chorus\])/gis, '$1');
    
    // ç§»é™¤å…¶ä»–æ ¼å¼è¯´æ˜ï¼Œå¦‚ (BPM 80)ã€Tempoç­‰
    lyrics = lyrics.replace(/\(BPM\s+\d+\)/gi, '');
    lyrics = lyrics.replace(/Tempo:.*/gi, '');
    lyrics = lyrics.replace(/èŠ‚å¥:.*/gi, '');
    
    // ç§»é™¤å¤šä½™çš„ç©ºç™½è¡Œ
    lyrics = lyrics.replace(/\n{3,}/g, '\n\n');
    
    // ç§»é™¤è¡Œé¦–è¡Œå°¾ç©ºç™½
    lyrics = lyrics.trim();
    
    return lyrics;
  }

  // æ˜¾ç¤ºæ­¥éª¤å†…å®¹
  // ç”Ÿæˆå°å‹ç§¯æœ¨åŠ¨ç”» HTML
  function getMiniBuildingAnimationHTML() {
    return `
      <div class="mini-building-animation">
        <div class="mini-blocks-container">
          <div class="mini-building-block"></div>
          <div class="mini-building-block"></div>
          <div class="mini-building-block"></div>
          <div class="mini-building-block"></div>
          <div class="mini-building-block"></div>
        </div>
      </div>
    `;
  }
  
  // æ£€æŸ¥å†…å®¹æ˜¯å¦å®Œå…¨ç”Ÿæˆ
  function isContentFullyGenerated(content) {
    if (!content) return false;
    // æ£€æŸ¥æ­Œè¯ã€å›¾ç‰‡ã€éŸ³ä¹æ˜¯å¦éƒ½æœ‰ç»“æœï¼ˆæˆåŠŸæˆ–å¤±è´¥éƒ½ç®—æœ‰ç»“æœï¼‰
    const hasLyrics = content.lyrics || content.lyricsError;
    const hasImage = content.imageUrl || content.imageError;
    const hasAudio = content.audioUrl || content.audioError;
    return hasLyrics && hasImage && hasAudio;
  }

  function displayStepContent(stepIndex) {
    const content = stepContents[stepIndex];
    const lyricsEl = $(`stepLyrics${stepIndex}`);
    const imageEl = $(`stepImage${stepIndex}`);
    const audioEl = $(`stepAudio${stepIndex}`);
    
    // æ£€æŸ¥å†…å®¹æ˜¯å¦å®Œå…¨ç”Ÿæˆ
    const isFullyGenerated = isContentFullyGenerated(content);
    
    if (!content || !isFullyGenerated) {
      // å¦‚æœå†…å®¹æœªå®Œå…¨ç”Ÿæˆï¼Œåœ¨æ­Œè¯å’Œå›¾ç‰‡åŒºåŸŸæ˜¾ç¤ºç§¯æœ¨åŠ¨ç”»
      if (lyricsEl) {
        lyricsEl.innerHTML = getMiniBuildingAnimationHTML();
      }
      if (imageEl) {
        imageEl.innerHTML = getMiniBuildingAnimationHTML();
      }
      // éŸ³ä¹åŒºåŸŸåœ¨ç”Ÿæˆæ—¶ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼ˆä¿æŒç©ºç™½ï¼‰
      if (audioEl) {
        audioEl.innerHTML = '';
      }
      return;
    }

    // æ˜¾ç¤ºæ­Œè¯ï¼ˆæ¸…ç†æ ¼å¼æ ‡è®°ï¼‰
    if (lyricsEl) {
      if (content.lyrics) {
        const cleanedLyrics = cleanLyrics(content.lyrics);
        lyricsEl.textContent = cleanedLyrics;
        lyricsEl.style.color = '#333';
        // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadLyricsBtn${stepIndex}`);
        if (downloadBtn) {
          downloadBtn.style.display = 'flex';
          downloadBtn.disabled = false;
        }
      } else if (content.lyricsError) {
        lyricsEl.textContent = `æ­Œè¯ç”Ÿæˆå¤±è´¥ï¼š${content.lyricsError}`;
        lyricsEl.style.color = '#b00020';
        // éšè—ä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadLyricsBtn${stepIndex}`);
        if (downloadBtn) downloadBtn.style.display = 'none';
      } else {
        lyricsEl.textContent = 'ç­‰å¾…ç”Ÿæˆ...';
        lyricsEl.style.color = '#999';
        // éšè—ä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadLyricsBtn${stepIndex}`);
        if (downloadBtn) downloadBtn.style.display = 'none';
      }
    }

    // æ˜¾ç¤ºå›¾ç‰‡
    if (imageEl) {
      if (content.imageUrl) {
        // ä¼˜å…ˆæ¸²æŸ“å ä½ï¼Œç­‰å¾…å›¾ç‰‡ onload åå†æ˜¾ç¤ºï¼Œå‡å°‘åˆ‡æ­¥æ—¶çš„ç©ºç™½æ—¶é—´
        imageEl.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${getMiniBuildingAnimationHTML()}</div>`;
        const img = new Image();
        img.onload = () => {
          imageEl.innerHTML = `<img src="${content.imageUrl}" alt="æ­¥éª¤ ${stepIndex + 1} å›¾ç‰‡" />`;
          // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
          const downloadBtn = $(`downloadImageBtn${stepIndex}`);
          if (downloadBtn) {
            downloadBtn.style.display = 'flex';
            downloadBtn.disabled = false;
          }
        };
        img.onerror = () => {
          imageEl.innerHTML = `<div style="text-align: center; padding: 20px; color: #b00020; display: flex; align-items: center; justify-content: center; height: 100%;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>`;
          // éšè—ä¸‹è½½æŒ‰é’®
          const downloadBtn = $(`downloadImageBtn${stepIndex}`);
          if (downloadBtn) downloadBtn.style.display = 'none';
        };
        img.src = content.imageUrl;
      } else if (content.imageError) {
        imageEl.innerHTML = `<div style="text-align: center; padding: 20px; color: #b00020; display: flex; align-items: center; justify-content: center; height: 100%;">å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼š${content.imageError}</div>`;
        // éšè—ä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadImageBtn${stepIndex}`);
        if (downloadBtn) downloadBtn.style.display = 'none';
      } else {
        imageEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; display: flex; align-items: center; justify-content: center; height: 100%;">ç­‰å¾…ç”Ÿæˆ...</div>';
        // éšè—ä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadImageBtn${stepIndex}`);
        if (downloadBtn) downloadBtn.style.display = 'none';
      }
    }

    // æ˜¾ç¤ºéŸ³ä¹
    if (audioEl) {
      if (content.audioUrl) {
        // åˆ›å»ºéšè—çš„audioå…ƒç´ 
        const audioId = `hiddenAudio${stepIndex}`;
        let hiddenAudio = document.getElementById(audioId);
        if (!hiddenAudio) {
          hiddenAudio = document.createElement('audio');
          hiddenAudio.id = audioId;
          hiddenAudio.className = 'audio-hidden';
          hiddenAudio.src = content.audioUrl;
          document.body.appendChild(hiddenAudio);
        } else {
          hiddenAudio.src = content.audioUrl;
        }
        
        // åˆ›å»ºæ§åˆ¶æŒ‰é’®å’Œè¿›åº¦æ¡
        audioEl.innerHTML = `
          <div class="audio-controls">
            <button class="audio-control-btn play-btn" onclick="togglePlayPause(${stepIndex})" id="playBtn${stepIndex}">â–¶</button>
            <button class="audio-control-btn restart" onclick="restartAudio(${stepIndex})" id="restartBtn${stepIndex}">â®</button>
            <div class="audio-progress-container">
              <div class="audio-progress-bar" id="progressBar${stepIndex}">
                <div class="audio-progress-fill" id="progressFill${stepIndex}" style="width: 0%;">
                  <div class="audio-progress-thumb" id="progressThumb${stepIndex}"></div>
                </div>
              </div>
              <div class="audio-time" id="audioTime${stepIndex}">0:00 / 0:00</div>
            </div>
          </div>
        `;
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
          if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ‹–æ‹½çŠ¶æ€
        let isDragging = false;
        let isUserSeeking = false;
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
          if (isDragging || isUserSeeking) return; // æ‹–æ‹½æ—¶ä¸è‡ªåŠ¨æ›´æ–°
          
          const progressFill = $(`progressFill${stepIndex}`);
          const audioTime = $(`audioTime${stepIndex}`);
          if (!hiddenAudio || !progressFill || !audioTime) return;
          
          if (hiddenAudio.duration && hiddenAudio.duration > 0) {
            const percent = (hiddenAudio.currentTime / hiddenAudio.duration) * 100;
            progressFill.style.width = percent + '%';
            audioTime.textContent = `${formatTime(hiddenAudio.currentTime)} / ${formatTime(hiddenAudio.duration)}`;
          } else {
            audioTime.textContent = `0:00 / 0:00`;
          }
        }
        
        // è®¾ç½®è¿›åº¦æ¡ä½ç½®
        function setProgress(percent) {
          const progressFill = $(`progressFill${stepIndex}`);
          if (!progressFill || !hiddenAudio || !hiddenAudio.duration) return;
          
          percent = Math.max(0, Math.min(100, percent));
          progressFill.style.width = percent + '%';
          
          if (hiddenAudio.duration > 0) {
            hiddenAudio.currentTime = (percent / 100) * hiddenAudio.duration;
            const audioTime = $(`audioTime${stepIndex}`);
            if (audioTime) {
              audioTime.textContent = `${formatTime(hiddenAudio.currentTime)} / ${formatTime(hiddenAudio.duration)}`;
            }
          }
        }
        
        // è·å–ç‚¹å‡»ä½ç½®å¯¹åº”çš„ç™¾åˆ†æ¯”
        function getPercentFromEvent(event) {
          const progressBar = $(`progressBar${stepIndex}`);
          if (!progressBar) return 0;
          
          const rect = progressBar.getBoundingClientRect();
          const clickX = event.clientX - rect.left;
          const percent = (clickX / rect.width) * 100;
          return Math.max(0, Math.min(100, percent));
        }
        
        // è¿›åº¦æ¡ç‚¹å‡»å’Œæ‹–æ‹½äº‹ä»¶
        const progressBar = $(`progressBar${stepIndex}`);
        if (progressBar) {
          // ç‚¹å‡»è·³è½¬
          progressBar.addEventListener('click', (e) => {
            if (!isDragging) {
              const percent = getPercentFromEvent(e);
              setProgress(percent);
            }
          });
          
          // æ‹–æ‹½å¼€å§‹
          progressBar.addEventListener('mousedown', (e) => {
            isDragging = true;
            isUserSeeking = true;
            const percent = getPercentFromEvent(e);
            setProgress(percent);
          });
          
          // æ‹–æ‹½ä¸­
          const handleMouseMove = (e) => {
            if (isDragging) {
              const percent = getPercentFromEvent(e);
              setProgress(percent);
            }
          };
          
          // æ‹–æ‹½ç»“æŸ
          const handleMouseUp = () => {
            if (isDragging) {
              isDragging = false;
              setTimeout(() => {
                isUserSeeking = false;
              }, 100);
            }
          };
          
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
          
          // è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰
          progressBar.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isDragging = true;
            isUserSeeking = true;
            const touch = e.touches[0];
            const rect = progressBar.getBoundingClientRect();
            const clickX = touch.clientX - rect.left;
            const percent = (clickX / rect.width) * 100;
            setProgress(percent);
          });
          
          const handleTouchMove = (e) => {
            if (isDragging) {
              e.preventDefault();
              const touch = e.touches[0];
              const rect = progressBar.getBoundingClientRect();
              const clickX = touch.clientX - rect.left;
              const percent = (clickX / rect.width) * 100;
              setProgress(percent);
            }
          };
          
          const handleTouchEnd = () => {
            if (isDragging) {
              isDragging = false;
              setTimeout(() => {
                isUserSeeking = false;
              }, 100);
            }
          };
          
          document.addEventListener('touchmove', handleTouchMove);
          document.addEventListener('touchend', handleTouchEnd);
        }
        
        // ç›‘å¬éŸ³é¢‘æ’­æ”¾çŠ¶æ€
        hiddenAudio.addEventListener('play', () => {
          const btn = $(`playBtn${stepIndex}`);
          if (btn) {
            btn.textContent = 'â¸';
            btn.classList.add('pause');
          }
        });
        
        hiddenAudio.addEventListener('pause', () => {
          const btn = $(`playBtn${stepIndex}`);
          if (btn) {
            btn.textContent = 'â–¶';
            btn.classList.remove('pause');
          }
        });
        
        hiddenAudio.addEventListener('ended', () => {
          const btn = $(`playBtn${stepIndex}`);
          if (btn) {
            btn.textContent = 'â–¶';
            btn.classList.remove('pause');
          }
        });
        
        // ç›‘å¬æ—¶é—´æ›´æ–°
        hiddenAudio.addEventListener('timeupdate', updateProgress);
        hiddenAudio.addEventListener('loadedmetadata', updateProgress);
        
        // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadAudioBtn${stepIndex}`);
        if (downloadBtn) {
          downloadBtn.style.display = 'flex';
          downloadBtn.disabled = false;
        }
      } else if (content.audioError) {
        audioEl.innerHTML = `<div style="text-align: center; padding: 20px; color: #b00020; display: flex; align-items: center; justify-content: center; height: 100%;">éŸ³ä¹ç”Ÿæˆå¤±è´¥ï¼š${content.audioError}</div>`;
        // éšè—ä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadAudioBtn${stepIndex}`);
        if (downloadBtn) downloadBtn.style.display = 'none';
      } else {
        // éŸ³ä¹åŒºåŸŸåœ¨ç”Ÿæˆæ—¶ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼ˆä¿æŒç©ºç™½ï¼‰
        audioEl.innerHTML = '';
        // éšè—ä¸‹è½½æŒ‰é’®
        const downloadBtn = $(`downloadAudioBtn${stepIndex}`);
        if (downloadBtn) downloadBtn.style.display = 'none';
      }
    }
    
    // æ›´æ–°æ€»ä¸‹è½½æŒ‰é’®çŠ¶æ€ï¼ˆåœ¨æ­Œè¯ä¸‹æ–¹çš„æŒ‰é’®ï¼‰
    const downloadAllBtn = $(`downloadAllBtn${stepIndex}`);
    if (downloadAllBtn && currentStepIndex === stepIndex) {
      const hasAllContent = content?.lyrics && content?.imageUrl && content?.audioUrl;
      downloadAllBtn.disabled = !hasAllContent;
      if (hasAllContent) {
        downloadAllBtn.style.display = 'flex';
      } else {
        downloadAllBtn.style.display = 'none';
      }
    }
  }

  // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
  function updateNavigationButtons() {
    const totalSteps = decomposedData.steps.length;
    $('btnPrev').disabled = currentStepIndex === 0;
    $('btnNext').disabled = currentStepIndex >= totalSteps - 1;
    $('btnRegenerate').disabled = !stepContents[currentStepIndex];
  }

  // ä¸Šä¸€æ­¥
  function goToPrevStep() {
    if (currentStepIndex > 0) {
      currentStepIndex--;
      showCurrentStep();
      updateNavigationButtons();
    }
  }

  // ä¸‹ä¸€æ­¥
  function goToNextStep() {
    const totalSteps = decomposedData.steps.length;
    if (currentStepIndex < totalSteps - 1) {
      currentStepIndex++;
      showCurrentStep();
      updateNavigationButtons();
    }
  }

  // é‡æ–°ç”Ÿæˆå½“å‰æ­¥éª¤
  async function regenerateCurrentStep() {
    if (isGeneratingAll) {
      alert('æ­£åœ¨ç”Ÿæˆæ‰€æœ‰å†…å®¹ï¼Œè¯·ç¨å€™...');
      return;
    }

    const step = decomposedData.steps[currentStepIndex];
    if (!step) return;

    const statusEl = $('generateStatus');
    statusEl.className = 'muted';
    statusEl.textContent = `æ­£åœ¨é‡æ–°ç”Ÿæˆæ­¥éª¤ ${currentStepIndex + 1}...`;
    $('btnRegenerate').disabled = true;

    try {
      // æ¸…é™¤å½“å‰æ­¥éª¤çš„ç¼“å­˜
      stepContents[currentStepIndex] = null;
      
      // é‡æ–°ç”Ÿæˆå†…å®¹
      await generateStepContent(currentStepIndex);
      
      // ç«‹å³æ˜¾ç¤ºæ–°ç”Ÿæˆçš„å†…å®¹
      displayStepContent(currentStepIndex);
      
      statusEl.className = 'ok';
      statusEl.textContent = `âœ… æ­¥éª¤ ${currentStepIndex + 1} é‡æ–°ç”Ÿæˆå®Œæˆï¼`;
      
      // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ­¥éª¤éƒ½å®Œæˆï¼Œå¦‚æœæ˜¯åˆ™ä¿å­˜å†å²è®°å½•
      const allStepsComplete = decomposedData.steps.every((step, index) => {
        const content = stepContents[index];
        if (!content) return false;
        const hasLyrics = content.lyrics || content.lyricsError;
        const hasImage = content.imageUrl || content.imageError;
        const hasAudio = content.audioUrl || content.audioError;
        return hasLyrics && hasImage && hasAudio;
      });
      
      if (allStepsComplete) {
        try {
          await saveHistory();
        } catch (e) {
          console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
        }
      }
    } catch (e) {
      statusEl.className = 'err';
      statusEl.textContent = `âŒ ç”Ÿæˆå¤±è´¥ï¼š${e?.message || e}`;
    } finally {
      $('btnRegenerate').disabled = false;
      updateNavigationButtons();
    }
  }

  // ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰æ­¥éª¤çš„å†…å®¹
  async function generateAllSteps() {
    if (!decomposedData || !decomposedData.steps || decomposedData.steps.length === 0) {
      alert('è¯·å…ˆåˆ†è§£å­¦ä¹ ç›®æ ‡');
      return;
    }

    if (isGeneratingAll) {
      alert('æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
      return;
    }

    isGeneratingAll = true;
    const statusEl = $('generateStatus');
    statusEl.className = 'muted';
    statusEl.textContent = 'æ­£åœ¨ç”Ÿæˆæ‰€æœ‰æ­¥éª¤çš„å†…å®¹ï¼Œè¯·ç¨å€™...';
    $('btnGenerateAll').style.display = 'none'; // éšè—æŒ‰é’®
    $('btnRegenerate').disabled = true;
    $('btnPrev').disabled = true;
    $('btnNext').disabled = true;

    try {
      const totalSteps = decomposedData.steps.length;
      
      for (let i = 0; i < totalSteps; i++) {
        statusEl.textContent = `æ­£åœ¨ç”Ÿæˆæ­¥éª¤ ${i + 1}/${totalSteps}...`;
        
        try {
          await generateStepContent(i);
        } catch (e) {
          console.error(`æ­¥éª¤ ${i + 1} ç”Ÿæˆå¤±è´¥:`, e);
          // ç»§ç»­ç”Ÿæˆå…¶ä»–æ­¥éª¤
        }
      }

      statusEl.className = 'ok';
      statusEl.textContent = `âœ… æ‰€æœ‰æ­¥éª¤å†…å®¹ç”Ÿæˆå®Œæˆï¼å…± ${totalSteps} ä¸ªæ­¥éª¤`;
      
      // æ˜¾ç¤ºå½“å‰æ­¥éª¤çš„å†…å®¹
      showCurrentStep();
      
      // ä¿å­˜å†å²è®°å½•ï¼ˆæ‰€æœ‰æ­¥éª¤éƒ½ç”Ÿæˆå®Œæˆï¼‰
      try {
        await saveHistory();
      } catch (e) {
        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
      }
    } catch (e) {
      statusEl.className = 'err';
      statusEl.textContent = `âŒ ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºé”™ï¼š${e?.message || e}`;
    } finally {
      isGeneratingAll = false;
      updateNavigationButtons();
    }
  }

  // ç”Ÿæˆå•ä¸ªæ­¥éª¤çš„å†…å®¹
  async function generateStepContent(stepIndex) {
    const step = decomposedData.steps[stepIndex];
    const characterName = decomposedData.character_name || 'å°åŠ¨ç‰©';
    const musicStyle = getActualValue('musicStyle', 'musicStyleCustom');
    const musicVoice = getActualValue('musicVoice', 'musicVoiceCustom');
    const pictureBookStyle = getActualValue('pictureBookStyle', 'pictureBookStyleCustom');
    const totalSteps = decomposedData.steps.length;

    // åˆå§‹åŒ–å†…å®¹ä¸ºç©ºå¯¹è±¡ï¼Œè¿™æ · displayStepContent ä¼šæ˜¾ç¤ºç§¯æœ¨åŠ¨ç”»
    stepContents[stepIndex] = {};
    
    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¿™ä¸ªæ­¥éª¤ï¼Œç«‹å³æ˜¾ç¤ºç§¯æœ¨åŠ¨ç”»
    if (currentStepIndex === stepIndex) {
      displayStepContent(stepIndex);
    }

    // ç”Ÿæˆæ­Œè¯
    const lyricsResp = await fetch('/api/generate-lyrics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        step,
        characterName,
        musicStyle,
        musicVoice,
        stepNumber: stepIndex + 1,
        totalSteps,
      }),
    });

    const lyricsData = await lyricsResp.json().catch(() => ({}));
    if (!lyricsResp.ok) {
      throw new Error(lyricsData?.error || 'æ­Œè¯ç”Ÿæˆå¤±è´¥');
    }

    let lyrics = lyricsData.lyrics || '';
    
    // æ¸…ç†æ­Œè¯ï¼Œç§»é™¤å¯èƒ½çš„æ—¶é•¿æŒ‡ä»¤ï¼ˆé¿å…é‡å¤ï¼‰
    lyrics = lyrics.replace(/\[Duration:.*?\]/gi, '').trim();

    // ç”Ÿæˆå›¾ç‰‡æç¤ºè¯ï¼ˆæ•´åˆç»˜æœ¬é£æ ¼ + è§’è‰²è®¾å®šå¡å¼ºç»‘å®šï¼‰
    const cs = decomposedData && decomposedData.character_sheet ? decomposedData.character_sheet : null;
    const csBlock = cs && cs.reference_prompt
      ? `\n\nè§’è‰²è®¾å®šå¡ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œæ‰€æœ‰æ­¥éª¤å®Œå…¨ä¸€è‡´ï¼Œä¸å…è®¸ä»»ä½•å˜åŒ–ï¼‰ï¼š\n${cs.reference_prompt}\n\nä¸€è‡´æ€§ç¡¬è§„åˆ™ï¼š\n- å¿…é¡»ä¿æŒåŒä¸€å¼ è„¸ã€åŒä¸€å‘å‹ã€åŒä¸€è¡£æœã€åŒä¸€é…é¥°ã€åŒä¸€ä¸»è‰²è°ƒã€åŒä¸€ç”»é£\n- ç¦æ­¢æ¢è£…ã€ç¦æ­¢æ¢å‘å‹ã€ç¦æ­¢å˜æˆä¸åŒäººç‰©/ä¸åŒåŠ¨ç‰©ã€ç¦æ­¢å¹´é¾„å˜åŒ–\n- å¦‚æœæ— æ³•ä¿è¯ä¸€è‡´æ€§ï¼Œè¯·é‡æ–°ç”Ÿæˆç›´åˆ°ä¸€è‡´\n`
      : `\n\nè§’è‰²ä¸€è‡´æ€§ç¡¬è§„åˆ™ï¼ˆç¼ºå°‘è®¾å®šå¡æ—¶ä»å¿…é¡»éµå®ˆï¼‰ï¼š\n- è§’è‰²â€œä¹ä¹â€å¿…é¡»å‡ºç°åœ¨ç”»é¢ä¸­\n- æ‰€æœ‰æ­¥éª¤ä¿æŒåŒä¸€å¼ è„¸ã€åŒä¸€å‘å‹ã€åŒä¸€è¡£æœã€åŒä¸€ç”»é£ï¼Œä¸æ¢è£…ä¸æ¢å‘å‹\n`;

    const imagePrompt = `ä¸º3-6å²è‡ªé—­ç—‡å„¿ç«¥åˆ›ä½œâ€œç»˜æœ¬åœºæ™¯æ’ç”»â€ã€‚\n\nå­¦ä¹ å†…å®¹ï¼š\n- å­¦ä¹ æ­¥éª¤ï¼š${step.step_name}\n- æ­¥éª¤æè¿°ï¼š${step.step_description}\n- å­¦ä¹ ç›®æ ‡ï¼š${step.learning_objective}\n- å½“å‰æ­¥éª¤ï¼šç¬¬${stepIndex + 1}æ­¥ï¼Œå…±${totalSteps}æ­¥\n- ç»˜æœ¬é£æ ¼ï¼š${pictureBookStyle}\n${csBlock}\næ ¸å¿ƒè¦æ±‚ï¼š\n1. **ç»˜æœ¬åœºæ™¯ï¼ˆä¸è¦åªç”»ä¸€ä¸ªç‰©ä½“ï¼‰**ï¼šå­¦ä¹ å¯¹è±¡å¿…é¡»å¤„åœ¨ä¸€ä¸ªæ¸©é¦¨çš„ç”Ÿæ´»åœºæ™¯ä¸­ï¼ˆå®¶é‡Œ/æ•™å®¤/å…¬å›­/å¨æˆ¿/æµ´å®¤/å®¢å…ç­‰ï¼‰ï¼Œå¹¶æœ‰é€‚é‡èƒŒæ™¯å…ƒç´ ï¼Œä½†ç”»é¢ä¸æ‹¥æŒ¤ã€‚\n2. **è§’è‰²å¿…é¡»å‡ºç°å¹¶ä¸è®¾å®šå¡å®Œå…¨ä¸€è‡´**ï¼šè§’è‰²â€œä¹ä¹â€å¿…é¡»å‡ºç°ï¼Œå¹¶ä¸¥æ ¼æŒ‰â€œè§’è‰²è®¾å®šå¡â€ç»˜åˆ¶ï¼Œæ‰€æœ‰æ­¥éª¤ä¸€è‡´ã€‚\n3. **å­¦ä¹ å¯¹è±¡æ¸…æ™°å¯è¾¨**ï¼šå­¦ä¹ å¯¹è±¡æ¸…æ™°ã€å‡†ç¡®ã€å é‡è¦ä½ç½®ï¼›è§’è‰²å¯ä»¥æŒ‡å‘/æ‹¿èµ·/ä½¿ç”¨è¯¥å¯¹è±¡ã€‚\n4. **ç¬¦åˆç”Ÿæ´»å¸¸è¯†**ï¼šç‰©å“ä¸åœºæ™¯ç¬¦åˆç°å®ï¼Œä¸æ‰­æ›²ã€ä¸è¶…ç°å®ã€‚\n5. **ç”»é¢ç®€æ´ä½†ä¸ç©º**ï¼šè‰²å½©æ˜äº®æŸ”å’Œï¼Œé¿å…å¼ºåˆºæ¿€å¯¹æ¯”ä¸å¤æ‚æ–‡å­—ã€‚\n6. **çªå‡ºæ ¸å¿ƒè®¤çŸ¥ç‚¹**ï¼šç”¨è§’è‰²åŠ¨ä½œçªå‡ºè¦å­¦çš„ç‚¹ï¼ˆå¦‚æ´—æ‰‹å°±åœ¨æ´—æ‰‹å°å‰æ´—æ‰‹ï¼‰ã€‚\n7. **ä¸¥æ ¼å®‰å…¨æ€§è¦æ±‚**ï¼šæ¸©é¦¨å®‰å…¨æ­£é¢ï¼Œé¿å…ææ€–/æš´åŠ›/å±é™©ç‰©å“ç­‰ã€‚\n8. **ç”»é¢è¿ç»­æ€§**ï¼šå¤šæ­¥éª¤å°½é‡ä¿æŒåŒä¸€åœ°ç‚¹/åŒä¸€è§’è‰²/åŒä¸€ç‰©å“å¤–è§‚è¿ç»­ã€‚\n\nè¯·ç”Ÿæˆä¸€å¹…ç¬¦åˆè¦æ±‚çš„ç»˜æœ¬æ’ç”»ã€‚`;

    // å¹¶è¡Œç”ŸæˆéŸ³ä¹å’Œå›¾ç‰‡
    const [musicResult, imageResult] = await Promise.allSettled([
      generateMusicForStep(lyrics, step.step_name, musicStyle, musicVoice),
      generateImageWithPrompt(imagePrompt),
    ]);

    // ä¿å­˜åˆ°ç¼“å­˜
    stepContents[stepIndex] = {
      lyrics: lyrics,
      imageUrl: imageResult.status === 'fulfilled' ? imageResult.value : null,
      audioUrl: musicResult.status === 'fulfilled' ? musicResult.value : null,
      imageError: imageResult.status === 'rejected' ? (imageResult.reason?.message || imageResult.reason) : null,
      audioError: musicResult.status === 'rejected' ? (musicResult.reason?.message || musicResult.reason) : null,
    };

    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¿™ä¸ªæ­¥éª¤ï¼Œç«‹å³æ›´æ–°æ˜¾ç¤º
    if (currentStepIndex === stepIndex) {
      displayStepContent(stepIndex);
    }
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€ï¼ˆå¦‚æœå½“å‰æ­¥éª¤æœ‰å†…å®¹äº†ï¼Œå¯ä»¥é‡æ–°ç”Ÿæˆï¼‰
    if (currentStepIndex === stepIndex) {
      updateNavigationButtons();
    }
    
    // è‡ªåŠ¨ä¿å­˜ç”Ÿæˆçš„å†…å®¹
    try {
      await saveStepContent(stepIndex);
    } catch (e) {
      console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', e);
    }
  }

  // ä¸ºæ­¥éª¤ç”ŸæˆéŸ³ä¹
  async function generateMusicForStep(lyrics, title, musicStyle, musicVoice) {
    // å½»åº•æ¸…ç†æ­Œè¯ï¼Œç§»é™¤æ‰€æœ‰æ—¶é•¿æ§åˆ¶æŒ‡ä»¤ï¼ˆé¿å…è¢«å½“ä½œæ­Œè¯å†…å®¹ï¼‰
    let cleanLyrics = lyrics.replace(/\[Duration:.*?\]/gi, '').trim();
    cleanLyrics = cleanLyrics.replace(/Make this song.*?seconds.*?\n/gi, '').trim();
    cleanLyrics = cleanLyrics.replace(/The song must be brief.*?\n/gi, '').trim();
    cleanLyrics = cleanLyrics.replace(/Keep it short and simple.*?\n/gi, '').trim();
    cleanLyrics = cleanLyrics.replace(/no longer than.*?\n/gi, '').trim();
    cleanLyrics = cleanLyrics.replace(/exactly.*?seconds.*?\n/gi, '').trim();
    // ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
    cleanLyrics = cleanLyrics.replace(/\n{3,}/g, '\n\n').trim();
    
    // ä¸å†åœ¨ prompt ä¸­æ·»åŠ æ—¶é•¿æŒ‡ä»¤ï¼Œåªé€šè¿‡ tags å’Œ title ä¼ é€’æ—¶é•¿è¦æ±‚
    // æ•´åˆéŸ³ä¹é£æ ¼å’Œå£°éŸ³ç±»å‹åˆ° tags
    const styleTags = `${musicStyle} style, ${musicVoice} voice, 40 seconds, short song, brief, quick, consistent vocal, same singer, stable tempo`;
    
    const payload = {
      mv: 'chirp-v4-5',
      custom_mode: true,
      make_instrumental: false,
      prompt: cleanLyrics, // åªä½¿ç”¨æ¸…ç†åçš„çº¯æ­Œè¯ï¼Œä¸åŒ…å«ä»»ä½•æŒ‡ä»¤æ–‡æœ¬
      title: title ? `${title} (40s, ${musicVoice}, Consistent Voice)` : `Short Song (40s, ${musicVoice}, Consistent Voice)`,
      tags: styleTags,
    };

    const submitResp = await fetch('/api/suno/submit/music', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!submitResp.ok) {
      const errorText = await submitResp.text().catch(() => '');
      throw new Error(`submit failed: ${submitResp.status} ${errorText}`);
    }

    const submitData = await submitResp.json().catch((e) => {
      throw new Error(`JSON parse error: ${e.message}`);
    });

    const taskId = submitData?.data?.taskId || 
                   submitData?.data?.task_id || 
                   submitData?.id || 
                   submitData?.data;

    if (!taskId) {
      const directUrl = pickFirstAudioUrl(submitData);
      if (directUrl) return directUrl;
      throw new Error('æœªæ‹¿åˆ°ä»»åŠ¡ id');
    }

    // è½®è¯¢è·å–ç»“æœ
    let i = 0;
    while (i < 20) { // æœ€å¤šè½®è¯¢20æ¬¡ï¼ˆ100ç§’ï¼‰
      await sleep(5000);
      const r = await fetchTask(taskId);

      const statusText = Array.isArray(r) ? 'success' : (r?.data?.status || r?.status || '');
      const st = String(statusText).toLowerCase();

      if (st && ['failed','error','canceled','cancelled','fail'].includes(st)) {
        const reason = r?.data?.status_reason || r?.data?.fail_reason || r?.fail_reason || '';
        throw new Error('ä»»åŠ¡å¤±è´¥: ' + statusText + (reason ? ('ï¼ŒåŸå› ï¼š' + JSON.stringify(reason)) : ''));
      }

      const url = pickFirstAudioUrl(r);
      if (url) {
        return url;
      }

      i++;
    }

    throw new Error('è½®è¯¢è¶…æ—¶ï¼šè¿˜æœªæ‹¿åˆ° audio_url');
  }

  // ä½¿ç”¨æŒ‡å®špromptç”Ÿæˆå›¾ç‰‡
  async function generateImageWithPrompt(imagePrompt) {
    // æ·»åŠ è´Ÿé¢æç¤ºè¯ï¼Œé¿å…ç”Ÿæˆä¸å®‰å…¨æˆ–ä¸ç¬¦åˆå¸¸è¯†çš„å›¾ç‰‡
    const negativePrompt = `ä½åˆ†è¾¨ç‡ï¼Œä½ç”»è´¨ï¼Œè‚¢ä½“ç•¸å½¢ï¼Œæ‰‹æŒ‡ç•¸å½¢ï¼Œç”»é¢è¿‡é¥±å’Œï¼Œèœ¡åƒæ„Ÿï¼Œäººè„¸æ— ç»†èŠ‚ï¼Œè¿‡åº¦å…‰æ»‘ï¼Œç”»é¢å…·æœ‰AIæ„Ÿã€‚æ„å›¾æ··ä¹±ã€‚æ–‡å­—æ¨¡ç³Šï¼Œæ‰­æ›²ã€‚ææ€–ï¼Œé»‘æš—ï¼Œé˜´æ£®ï¼Œæš´åŠ›ï¼Œå†²çªï¼Œäº‰åµï¼Œæ‚²ä¼¤ï¼Œå“­æ³£ï¼Œå®³æ€•ï¼Œå±é™©ç‰©å“ï¼Œæ€ªç‰©ï¼Œé¬¼æ€ªï¼Œææ€–è§’è‰²ï¼ŒæƒŠå“å…ƒç´ ï¼Œç„¦è™‘ï¼Œææƒ§ï¼Œæ‰­æ›²ï¼Œå˜å½¢ï¼Œä¸ç¬¦åˆå¸¸è¯†ï¼Œå¥‡æ€ªçš„é¢œè‰²ï¼Œä¸ç¬¦åˆç°å®ï¼Œè§’è‰²ï¼Œäººç‰©ï¼ŒåŠ¨ç‰©ï¼Œå¡é€šå½¢è±¡ï¼ŒæŠ½è±¡ï¼Œè¶…ç°å®ï¼Œè‰ºæœ¯åŒ–ï¼Œé£æ ¼åŒ–`;
    
    const resp = await fetch('/api/generate-image', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        prompt: imagePrompt, 
        size: '1664*928',
        negative_prompt: negativePrompt
      }),
    });

    const data = await resp.json().catch(() => ({}));

    if (!resp.ok) {
      throw new Error(data?.error || `HTTP ${resp.status}`);
    }

    if (!data.image_url) {
      throw new Error('æœªè¿”å›å›¾ç‰‡URL');
    }

    return data.image_url;
  }

  // è¾…åŠ©å‡½æ•°
  async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function fetchTask(id) {
    const res = await fetch('/api/suno/fetch?id=' + encodeURIComponent(id));
    if (!res.ok) {
      const errorText = await res.text().catch(() => '');
      throw new Error(`fetch failed: ${res.status} ${errorText}`);
    }
    return await res.json().catch((e) => {
      throw new Error(`JSON parse error: ${e.message}`);
    });
  }

  function pickFirstAudioUrl(resp) {
    const resultArray = resp?.data?.result;
    if (Array.isArray(resultArray)) {
      for (const item of resultArray) {
        if (item?.audio_url) return item.audio_url;
      }
    }

    const dataArray = resp?.data?.data;
    if (Array.isArray(dataArray)) {
      for (const item of dataArray) {
        if (item?.audio_url) return item.audio_url;
      }
    }

    const candidates = [resp, resp?.data, resp?.data?.data, resp?.data?.data?.data];
    for (const obj of candidates) {
      if (Array.isArray(obj)) continue;
      const clips = obj?.clips;
      if (Array.isArray(clips)) {
        for (const c of clips) {
          if (c?.audio_url) return c.audio_url;
        }
      }
      if (obj?.audio_url) return obj.audio_url;
    }
    return '';
  }

  // æ’­æ”¾/æš‚åœåˆ‡æ¢
  function togglePlayPause(stepIndex) {
    const audio = document.getElementById(`hiddenAudio${stepIndex}`);
    if (!audio) return;
    
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
  }

  // é‡æ–°æ’­æ”¾
  function restartAudio(stepIndex) {
    const audio = document.getElementById(`hiddenAudio${stepIndex}`);
    if (!audio) return;
    
    audio.currentTime = 0;
    audio.play();
  }
  
  // è·³è½¬åˆ°æŒ‡å®šä½ç½®ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼Œä½†ä¸»è¦ä½¿ç”¨æ‹–æ‹½åŠŸèƒ½ï¼‰
  function seekAudio(stepIndex, event) {
    const audio = document.getElementById(`hiddenAudio${stepIndex}`);
    const progressBar = document.getElementById(`progressBar${stepIndex}`);
    if (!audio || !progressBar || !audio.duration) return;
    
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percent = (clickX / rect.width) * 100;
    audio.currentTime = (percent / 100) * audio.duration;
  }

  // ä¿å­˜ç”Ÿæˆçš„å†…å®¹
  async function saveStepContent(stepIndex) {
    const content = stepContents[stepIndex];
    if (!content) {
      return; // é™é»˜è¿”å›ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
    }

    const step = decomposedData.steps[stepIndex];
    const stepName = step.step_name || `æ­¥éª¤${stepIndex + 1}`;
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¿å­˜ï¼Œç”Ÿæˆæ–°çš„ sessionId
    if (!currentSessionId) {
      currentSessionId = `session_${Date.now()}`;
    }
    
    try {
      const resp = await fetch('/api/save-content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          stepIndex: stepIndex + 1,
          stepName: stepName,
          lyrics: content.lyrics,
          imageUrl: content.imageUrl,
          audioUrl: content.audioUrl,
          sessionId: currentSessionId,
        }),
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }

      // æ›´æ–° sessionIdï¼ˆå¦‚æœæœåŠ¡å™¨è¿”å›äº†æ–°çš„ï¼‰
      if (data.sessionId) {
        currentSessionId = data.sessionId;
      }

      console.log(`âœ… æ­¥éª¤ ${stepIndex + 1} å†…å®¹å·²ä¿å­˜åˆ°: ${data.savedDir}`);
    } catch (e) {
      console.error(`âŒ ä¿å­˜å¤±è´¥ï¼š${e?.message || e}`);
    }
  }

  // ä¸‹è½½åŠŸèƒ½è¾…åŠ©å‡½æ•°
  async function downloadFile(url, filename, mimeType) {
    try {
      // æ£€æŸ¥æ˜¯å¦æ”¯æŒ File System Access APIï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
      if ('showDirectoryPicker' in window) {
        // ä½¿ç”¨ File System Access API è®©ç”¨æˆ·é€‰æ‹©æ–‡ä»¶å¤¹
        const dirHandle = await window.showDirectoryPicker();
        const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
        const writable = await fileHandle.createWritable();
        
        // è·å–æ–‡ä»¶å†…å®¹
        const response = await fetch(url);
        const blob = await response.blob();
        await writable.write(blob);
        await writable.close();
        
        return true;
      } else {
        // ä¼ ç»Ÿä¸‹è½½æ–¹å¼ï¼ˆä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹ï¼‰
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        
        return true;
      }
    } catch (error) {
      console.error('ä¸‹è½½å¤±è´¥:', error);
      // å¦‚æœ File System Access API å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿä¸‹è½½
      if (error.name !== 'AbortError') {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
          
          return true;
        } catch (e) {
          console.error('ä¼ ç»Ÿä¸‹è½½ä¹Ÿå¤±è´¥:', e);
          alert('ä¸‹è½½å¤±è´¥ï¼š' + (e.message || e));
          return false;
        }
      }
      return false;
    }
  }

  // ä¸‹è½½æ–‡æœ¬æ–‡ä»¶
  async function downloadTextFile(content, filename) {
    try {
      // æ£€æŸ¥æ˜¯å¦æ”¯æŒ File System Access API
      if ('showDirectoryPicker' in window) {
        const dirHandle = await window.showDirectoryPicker();
        const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
        const writable = await fileHandle.createWritable();
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        await writable.write(blob);
        await writable.close();
        
        return true;
      } else {
        // ä¼ ç»Ÿä¸‹è½½æ–¹å¼
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const blobUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        
        return true;
      }
    } catch (error) {
      console.error('ä¸‹è½½å¤±è´¥:', error);
      if (error.name !== 'AbortError') {
        // å›é€€åˆ°ä¼ ç»Ÿä¸‹è½½
        try {
          const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
          const blobUrl = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
          
          return true;
        } catch (e) {
          alert('ä¸‹è½½å¤±è´¥ï¼š' + (e.message || e));
          return false;
        }
      }
      return false;
    }
  }

  // ä¸‹è½½æ­Œè¯
  async function downloadLyrics(stepIndex) {
    const content = stepContents[stepIndex];
    if (!content || !content.lyrics) {
      alert('æ­Œè¯å°šæœªç”Ÿæˆ');
      return;
    }

    const step = decomposedData.steps[stepIndex];
    const stepName = step.step_name || `æ­¥éª¤${stepIndex + 1}`;
    const filename = `æ­¥éª¤${stepIndex + 1}_${stepName}_æ­Œè¯.txt`;
    
    const cleanedLyrics = cleanLyrics(content.lyrics);
    await downloadTextFile(cleanedLyrics, filename);
  }

  // ä¸‹è½½å›¾ç‰‡
  async function downloadImage(stepIndex) {
    const content = stepContents[stepIndex];
    if (!content || !content.imageUrl) {
      alert('å›¾ç‰‡å°šæœªç”Ÿæˆ');
      return;
    }

    const step = decomposedData.steps[stepIndex];
    const stepName = step.step_name || `æ­¥éª¤${stepIndex + 1}`;
    const filename = `æ­¥éª¤${stepIndex + 1}_${stepName}_å›¾ç‰‡.png`;
    
    await downloadFile(content.imageUrl, filename, 'image/png');
  }

  // ä¸‹è½½éŸ³é¢‘
  async function downloadAudio(stepIndex) {
    const content = stepContents[stepIndex];
    if (!content || !content.audioUrl) {
      alert('éŸ³é¢‘å°šæœªç”Ÿæˆ');
      return;
    }

    const step = decomposedData.steps[stepIndex];
    const stepName = step.step_name || `æ­¥éª¤${stepIndex + 1}`;
    const filename = `æ­¥éª¤${stepIndex + 1}_${stepName}_éŸ³é¢‘.mp3`;
    
    await downloadFile(content.audioUrl, filename, 'audio/mpeg');
  }

  // ä¸‹è½½æ‰€æœ‰å†…å®¹ï¼ˆæ­Œè¯ã€å›¾ç‰‡ã€éŸ³é¢‘ï¼‰
  async function downloadAllStepContent(stepIndex) {
    const content = stepContents[stepIndex];
    if (!content) {
      alert('å†…å®¹å°šæœªç”Ÿæˆ');
      return;
    }

    const hasAll = content.lyrics && content.imageUrl && content.audioUrl;
    if (!hasAll) {
      alert('éƒ¨åˆ†å†…å®¹å°šæœªç”Ÿæˆï¼Œæ— æ³•ä¸‹è½½å…¨éƒ¨');
      return;
    }

    const step = decomposedData.steps[stepIndex];
    const stepName = step.step_name || `æ­¥éª¤${stepIndex + 1}`;
    const folderName = `æ­¥éª¤${stepIndex + 1}_${stepName}`;

    try {
      // æ£€æŸ¥æ˜¯å¦æ”¯æŒ File System Access API
      if ('showDirectoryPicker' in window) {
        // è®©ç”¨æˆ·é€‰æ‹©æ–‡ä»¶å¤¹
        const dirHandle = await window.showDirectoryPicker();
        
        // åˆ›å»ºå­æ–‡ä»¶å¤¹ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯çˆ¶æ–‡ä»¶å¤¹ï¼‰
        let targetDirHandle = dirHandle;
        try {
          targetDirHandle = await dirHandle.getDirectoryHandle(folderName, { create: true });
        } catch (e) {
          // å¦‚æœæ— æ³•åˆ›å»ºå­æ–‡ä»¶å¤¹ï¼Œç›´æ¥ä½¿ç”¨é€‰æ‹©çš„æ–‡ä»¶å¤¹
          targetDirHandle = dirHandle;
        }

        // ä¸‹è½½æ­Œè¯
        const lyricsFilename = `æ­Œè¯.txt`;
        const lyricsFileHandle = await targetDirHandle.getFileHandle(lyricsFilename, { create: true });
        const lyricsWritable = await lyricsFileHandle.createWritable();
        const cleanedLyrics = cleanLyrics(content.lyrics);
        const lyricsBlob = new Blob([cleanedLyrics], { type: 'text/plain;charset=utf-8' });
        await lyricsWritable.write(lyricsBlob);
        await lyricsWritable.close();

        // ä¸‹è½½å›¾ç‰‡
        const imageFilename = `å›¾ç‰‡.png`;
        const imageResponse = await fetch(content.imageUrl);
        const imageBlob = await imageResponse.blob();
        const imageFileHandle = await targetDirHandle.getFileHandle(imageFilename, { create: true });
        const imageWritable = await imageFileHandle.createWritable();
        await imageWritable.write(imageBlob);
        await imageWritable.close();

        // ä¸‹è½½éŸ³é¢‘
        const audioFilename = `éŸ³é¢‘.mp3`;
        const audioResponse = await fetch(content.audioUrl);
        const audioBlob = await audioResponse.blob();
        const audioFileHandle = await targetDirHandle.getFileHandle(audioFilename, { create: true });
        const audioWritable = await audioFileHandle.createWritable();
        await audioWritable.write(audioBlob);
        await audioWritable.close();

        alert('âœ… æ‰€æœ‰å†…å®¹å·²ä¸‹è½½å®Œæˆï¼');
      } else {
        // ä¼ ç»Ÿä¸‹è½½æ–¹å¼ï¼šé€ä¸ªä¸‹è½½ï¼ˆæµè§ˆå™¨ä¼šæç¤ºä¿å­˜ä½ç½®ï¼‰
        const cleanedLyrics = cleanLyrics(content.lyrics);
        
        // ä¸‹è½½æ­Œè¯
        await downloadTextFile(cleanedLyrics, `${folderName}_æ­Œè¯.txt`);
        await new Promise(resolve => setTimeout(resolve, 300)); // å»¶è¿Ÿé¿å…æµè§ˆå™¨é˜»æ­¢å¤šä¸ªä¸‹è½½
        
        // ä¸‹è½½å›¾ç‰‡
        await downloadFile(content.imageUrl, `${folderName}_å›¾ç‰‡.png`, 'image/png');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // ä¸‹è½½éŸ³é¢‘
        await downloadFile(content.audioUrl, `${folderName}_éŸ³é¢‘.mp3`, 'audio/mpeg');
        
        alert('âœ… æ‰€æœ‰å†…å®¹å·²å¼€å§‹ä¸‹è½½ï¼è¯·æ£€æŸ¥æµè§ˆå™¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚');
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶å¤¹é€‰æ‹©ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
        return;
      }
      console.error('ä¸‹è½½å¤±è´¥:', error);
      alert('ä¸‹è½½å¤±è´¥ï¼š' + (error.message || error));
    }
  }

  // ä¿å­˜å†å²è®°å½•ï¼ˆå½“æ‰€æœ‰æ­¥éª¤éƒ½ç”Ÿæˆå®Œæˆæ—¶ï¼‰
  async function saveHistory() {
    if (!decomposedData || !stepContents || !currentSessionId) {
      return;
    }

    // æ£€æŸ¥æ‰€æœ‰æ­¥éª¤æ˜¯å¦éƒ½å®Œå…¨ç”Ÿæˆ
    const allStepsComplete = decomposedData.steps.every((step, index) => {
      const content = stepContents[index];
      if (!content) return false;
      const hasLyrics = content.lyrics || content.lyricsError;
      const hasImage = content.imageUrl || content.imageError;
      const hasAudio = content.audioUrl || content.audioError;
      return hasLyrics && hasImage && hasAudio;
    });

    if (!allStepsComplete) {
      console.log('éƒ¨åˆ†æ­¥éª¤æœªå®Œæˆï¼Œä¸ä¿å­˜å†å²è®°å½•');
      return;
    }

    try {
      const userGoal = $('userGoal').value.trim();
      const learningFocus = $('learningFocus').value.trim();
      const musicStyle = getActualValue('musicStyle', 'musicStyleCustom');
      const musicVoice = getActualValue('musicVoice', 'musicVoiceCustom');
      const pictureBookStyle = getActualValue('pictureBookStyle', 'pictureBookStyleCustom');
      const characterType = getActualValue('characterType', 'characterTypeCustom');

      const resp = await fetch('/api/save-history', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sessionId: currentSessionId,
          decomposedData: decomposedData,
          stepContents: stepContents,
          userGoal: userGoal,
          learningFocus: learningFocus,
          musicStyle: musicStyle,
          musicVoice: musicVoice,
          pictureBookStyle: pictureBookStyle,
          characterType: characterType,
        }),
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }

      console.log('âœ… å†å²è®°å½•å·²ä¿å­˜');
    } catch (e) {
      console.error('âŒ ä¿å­˜å†å²è®°å½•å¤±è´¥ï¼š', e?.message || e);
    }
  }

  // æ˜¾ç¤ºå†å²è®°å½•æ¨¡æ€æ¡†
  async function showHistoryModal() {
    const modal = $('historyModal');
    if (modal) {
      modal.classList.add('active');
      await loadHistoryList();
    }
  }

  // éšè—å†å²è®°å½•æ¨¡æ€æ¡†
  function hideHistoryModal() {
    const modal = $('historyModal');
    if (modal) {
      modal.classList.remove('active');
    }
  }

  // åŠ è½½å†å²è®°å½•åˆ—è¡¨
  async function loadHistoryList() {
    const historyListEl = $('historyList');
    if (!historyListEl) return;

    historyListEl.innerHTML = '<div class="history-loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>';

    try {
      const resp = await fetch('/api/history');
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }

      historyData = data.history || [];

      if (historyData.length === 0) {
        historyListEl.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•</div>';
        $('historyPagination').style.display = 'none';
        return;
      }

      // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      historyData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      historyCurrentPage = 1;
      renderHistoryPage();
    } catch (e) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
      historyListEl.innerHTML = `<div class="history-empty" style="color: #b00020;">åŠ è½½å¤±è´¥ï¼š${e?.message || e}</div>`;
      $('historyPagination').style.display = 'none';
    }
  }

  // æ¸²æŸ“å†å²è®°å½•é¡µé¢
  function renderHistoryPage() {
    const historyListEl = $('historyList');
    const paginationEl = $('historyPagination');
    if (!historyListEl || !paginationEl) return;

    const totalPages = Math.ceil(historyData.length / historyPageSize);
    const startIndex = (historyCurrentPage - 1) * historyPageSize;
    const endIndex = startIndex + historyPageSize;
    const currentPageData = historyData.slice(startIndex, endIndex);

    if (currentPageData.length === 0) {
      historyListEl.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•</div>';
      paginationEl.style.display = 'none';
      return;
    }

    historyListEl.innerHTML = currentPageData.map(item => {
      const date = new Date(item.createdAt);
      const dateStr = date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });

      return `
        <div class="history-item">
          <div class="history-item-content">
            <div class="history-item-title">${item.userGoal || 'æœªå‘½å'}</div>
            <div class="history-item-meta-row">
              <div class="history-item-meta">
                <div>${dateStr}</div>
                <div>å…± ${item.stepCount} ä¸ªæ­¥éª¤</div>
              </div>
              <button class="history-item-btn" onclick="importHistory('${item.sessionId}')">
                ğŸ“¥ å¯¼å…¥
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    if (totalPages > 1) {
      paginationEl.style.display = 'flex';
      $('historyPageInfo').textContent = `${historyCurrentPage} / ${totalPages}`;
      $('historyPrevBtn').disabled = historyCurrentPage === 1;
      $('historyNextBtn').disabled = historyCurrentPage === totalPages;
    } else {
      paginationEl.style.display = 'none';
    }
  }

  // ä¸Šä¸€é¡µ
  function historyPrevPage() {
    if (historyCurrentPage > 1) {
      historyCurrentPage--;
      renderHistoryPage();
    }
  }

  // ä¸‹ä¸€é¡µ
  function historyNextPage() {
    const totalPages = Math.ceil(historyData.length / historyPageSize);
    if (historyCurrentPage < totalPages) {
      historyCurrentPage++;
      renderHistoryPage();
    }
  }

  // å¯¼å…¥å†å²è®°å½•
  async function importHistory(sessionId) {
    if (!sessionId) {
      alert('æ— æ•ˆçš„å†å²è®°å½•ID');
      return;
    }

    try {
      const resp = await fetch(`/api/history/${sessionId}`);
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }

      const historyData = data.data;
      if (!historyData) {
        throw new Error('å†å²è®°å½•æ•°æ®ä¸ºç©º');
      }

      // å¯¼å…¥åˆ†è§£æ•°æ®
      decomposedData = historyData.decomposedData;
      currentStepIndex = 0;

      // å¯¼å…¥æ­¥éª¤å†…å®¹ - ä»æœ¬åœ° data æ–‡ä»¶å¤¹åŠ è½½
      stepContents = await Promise.all(historyData.stepContents.map(async (item, index) => {
        const stepNumber = index + 1;
        let lyricsContent = '';
        let lyricsErr = null;

        try {
          // ä»æ–°æ¥å£åŠ è½½æ­Œè¯
          const lyricsResp = await fetch(`/api/asset?session=${sessionId}&step=${stepNumber}&type=lyrics`);
          if (lyricsResp.ok) {
            lyricsContent = await lyricsResp.text();
          } else if (lyricsResp.status !== 404) { // 404 is acceptable (old data)
            lyricsErr = `Failed to load local lyrics (status: ${lyricsResp.status})`;
          }
        } catch (e) {
          lyricsErr = `Error fetching local lyrics: ${e.message}`;
        }

        return {
          lyrics: lyricsContent || item.lyrics, // Fallback to old data if local fails
          imageUrl: `/api/asset?session=${sessionId}&step=${stepNumber}&type=image`,
          audioUrl: `/api/asset?session=${sessionId}&step=${stepNumber}&type=audio`,
          lyricsError: lyricsErr,
          imageError: null, // Errors will be handled by onerror events
          audioError: null,
        };
      }));

      // å¯¼å…¥è®¾ç½®
      if (historyData.userGoal) {
        $('userGoal').value = historyData.userGoal;
      }
      if (historyData.learningFocus) {
        $('learningFocus').value = historyData.learningFocus;
      }
      if (historyData.musicStyle) {
        $('musicStyle').value = historyData.musicStyle;
      }
      if (historyData.musicVoice) {
        $('musicVoice').value = historyData.musicVoice;
      }
      if (historyData.pictureBookStyle) {
        $('pictureBookStyle').value = historyData.pictureBookStyle;
      }
      if (historyData.characterType) {
        $('characterType').value = historyData.characterType;
      }

      // æ›´æ–° sessionId
      currentSessionId = sessionId;

      // æ˜¾ç¤ºè§’è‰²ä¿¡æ¯
      if (decomposedData.character_name) {
        $('characterInfo').style.display = 'block';
        $('characterDetails').innerHTML = `
          <div><strong>è§’è‰²ï¼š</strong>${decomposedData.character_name}</div>
          <div style="margin-top: 4px;"><strong>æè¿°ï¼š</strong>${decomposedData.character_description || 'å¯çˆ±çš„å­¦ä¹ ä¼™ä¼´'}</div>
        `;
      }

      // æ˜¾ç¤ºæ­¥éª¤åŒºåŸŸ
      $('stepsSection').style.display = 'block';
      $('welcomeMessage').style.display = 'none';
      $('stepsContainer').style.display = 'block';

      // æ¸²æŸ“æ­¥éª¤
      renderStepIndicator();
      renderStepContents();
      showCurrentStep();
      updateNavigationButtons();

      // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
      hideHistoryModal();

      alert('âœ… å†å²è®°å½•å¯¼å…¥æˆåŠŸï¼');
    } catch (e) {
      console.error('å¯¼å…¥å†å²è®°å½•å¤±è´¥:', e);
      alert('å¯¼å…¥å¤±è´¥ï¼š' + (e?.message || e));
    }
  }

  // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.togglePlayPause = togglePlayPause;
  window.restartAudio = restartAudio;
  window.seekAudio = seekAudio;
  window.seekAudio = seekAudio;
  window.saveStepContent = saveStepContent;
  window.downloadLyrics = downloadLyrics;
  window.downloadImage = downloadImage;
  window.downloadAudio = downloadAudio;
  window.downloadAllStepContent = downloadAllStepContent;
  window.showHistoryModal = showHistoryModal;
  window.hideHistoryModal = hideHistoryModal;
  window.importHistory = importHistory;
  window.historyPrevPage = historyPrevPage;
  window.historyNextPage = historyNextPage;
  window.historyPrevPage = historyPrevPage;
  window.historyNextPage = historyNextPage;

  // åˆå§‹åŒ–è‡ªå®šä¹‰è¾“å…¥å¤„ç†
  setupCustomInputs();

  // äº‹ä»¶ç›‘å¬
  $('btnDecompose').addEventListener('click', decomposeGoal);
  $('btnPrev').addEventListener('click', goToPrevStep);
  $('btnNext').addEventListener('click', goToNextStep);
  $('btnRegenerate').addEventListener('click', regenerateCurrentStep);
  $('btnGenerateAll').addEventListener('click', generateAllSteps);
</script>
</body>
</html>
